<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="color-scheme" content="light" />
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <title>Settings</title>

    <!-- Preload theme script to prevent flash -->
    <script>
        // Apply theme immediately before page renders to prevent flash
        (function() {
            try {
                const savedSettings = localStorage.getItem('homeSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    const themeName = settings.theme || 'default';
                    const isDarkMode = settings.darkMode || false;
                    
                    // Apply dark mode class
                    document.documentElement.classList.toggle('dark-mode', isDarkMode);
                    
                    // Store theme data in a data attribute for components to access
                    document.documentElement.dataset.theme = themeName;
                    document.documentElement.dataset.darkMode = isDarkMode;
                    
                    // Define basic theme properties - just enough to prevent flash
                    const BASIC_THEMES = {
                        default: {
                            light: {
                                background: '#f8f5e6',
                                gradient: 'linear-gradient(135deg, #f8f5e6, #f2edd0)',
                                text: '#222222'
                            },
                            dark: {
                                background: '#1a1a1a',
                                gradient: 'linear-gradient(135deg, #222, #333)',
                                text: '#e0e0e0'
                            }
                        },
                        minimal: {
                            light: {
                                background: '#ffffff',
                                gradient: 'none',
                                text: '#000000'
                            },
                            dark: {
                                background: '#000000',
                                gradient: 'none',
                                text: '#ffffff'
                            }
                        },
                        glass: {
                            light: {
                                background: 'rgba(255, 255, 255, 0.7)',
                                gradient: 'linear-gradient(135deg, #f5f7fa, #c3cfe2)',
                                text: '#334155'
                            },
                            dark: {
                                background: 'rgba(15, 23, 42, 0.7)',
                                gradient: 'linear-gradient(135deg, #0f172a, #1e293b)',
                                text: '#e2e8f0'
                            }
                        },
                        ocean: {
                            light: {
                                background: '#e0f7fa',
                                gradient: 'linear-gradient(135deg, #e0f7fa, #80deea 50%, #4dd0e1)',
                                text: '#006064'
                            },
                            dark: {
                                background: '#002f35',
                                gradient: 'linear-gradient(135deg, #002f35, #00363a 50%, #004d40)',
                                text: '#e0f7fa'
                            }
                        },
                        swiss: {
                            light: {
                                background: '#ffffff',
                                gradient: 'none',
                                text: '#111111'
                            },
                            dark: {
                                background: '#000000',
                                gradient: 'none',
                                text: '#ffffff'
                            }
                        }
                    };
                    
                    // Apply basic colors immediately
                    const theme = BASIC_THEMES[themeName] || BASIC_THEMES.default;
                    const colors = isDarkMode ? theme.dark : theme.light;
                    
                    document.documentElement.style.backgroundColor = colors.background;
                    document.documentElement.style.color = colors.text;
                    
                    if (colors.gradient && colors.gradient !== 'none') {
                        document.documentElement.style.backgroundImage = colors.gradient;
                    }
                }
            } catch (e) {
                console.error('Error pre-loading theme:', e);
            }
        })();
    </script>

    <style>
        :root {
            --border-radius: 8px;
            --color-background: #f8f5e6; /* Vanilla/yellowish background */
            --color-text-subtle: #666666; /* Subtle gray text */
            --color-text: #222222; /* Near black text */
            --color-accent: #333333; /* Accent color */
            --color-hover: #444444; /* Hover color */
            --color-accent-rgb: 51, 51, 51; /* RGB values for accent color */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-size: clamp(13px, 1vw, 15px); /* Smaller font size */
            --font-weight-bold: 500;
            --font-weight-normal: 400;
            --space: .5rem;
            --transition-speed: 200ms;
            --box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03);
        }

        html {
            background-color: var(--color-background);
            background-image: linear-gradient(135deg, #f8f5e6, #f2edd0);
            font-family: var(--font-family);
            font-size: var(--font-size);
            line-height: 1.4;
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            color: var(--color-text);
            min-height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 2rem;
            padding-bottom: 4rem;
        }

        .back-link {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            padding: 0.7rem 1.2rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            z-index: 100;
            text-decoration: none;
        }

        .back-link:hover {
            color: var(--color-text);
        }

        .back-link::before {
            content: "←";
            margin-right: 0.5rem;
            font-size: 1.2em;
        }

        .settings-container {
            width: 100%;
            max-width: 1200px;
            padding: 2rem;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            align-items: start;
            box-sizing: border-box;
        }

        .settings-header {
            grid-column: 1 / -1;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header-content {
            flex: 1;
        }

        .settings-title {
            font-size: 1.8rem;
            font-weight: var(--font-weight-bold);
            margin: 0 0 0.5rem 0;
        }

        .settings-description {
            color: var(--color-text-subtle);
            margin: 0;
            font-size: 0.9rem;
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            height: fit-content;
        }

        html.dark-mode .settings-section {
            background: rgba(30, 30, 30, 0.5);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .settings-section-title {
            font-size: 1.2rem;
            font-weight: var(--font-weight-bold);
            margin: 0 0 1.2rem 0;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-section-title::before {
            content: "";
            display: inline-block;
            width: 4px;
            height: 1.2em;
            background-color: var(--color-accent);
            border-radius: 2px;
        }

        .settings-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: var(--border-radius);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .settings-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        html.dark-mode .settings-option {
            background-color: rgba(40, 40, 40, 0.5);
            border-color: rgba(255, 255, 255, 0.05);
        }

        html.dark-mode .settings-option:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .settings-option:last-child {
            margin-bottom: 0;
        }

        .settings-option-label {
            font-size: 0.95rem;
            color: var(--color-text);
            font-weight: var(--font-weight-bold);
        }

        .settings-option-description {
            display: block;
            font-size: 0.8rem;
            color: var(--color-text-subtle);
            margin-top: 0.3rem;
            max-width: 80%;
        }

        /* Make shortcuts section full width */
        .settings-section.shortcuts-section {
            grid-column: 1 / -1;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.7);
        }

        html.dark-mode .settings-section.shortcuts-section {
            background: rgba(30, 30, 30, 0.7);
        }

        .shortcuts-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            list-style: none;
            padding: 0;
        }

        .shortcut-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius);
            padding: 1.2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        html.dark-mode .shortcut-item {
            background: rgba(40, 40, 40, 0.8);
            border-color: rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .shortcut-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .shortcut-key {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-accent);
            color: white;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: var(--font-weight-bold);
            flex-shrink: 0;
        }

        .shortcut-details {
            flex: 1;
            min-width: 0;
        }

        .shortcut-name {
            font-size: 1rem;
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
            margin-bottom: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shortcut-url {
            font-size: 0.85rem;
            color: var(--color-text-subtle);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shortcut-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .shortcut-edit-btn, .shortcut-delete-btn {
            flex: 1;
            padding: 0.6rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.5);
            color: var(--color-text);
            font-size: 0.85rem;
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .shortcut-edit-btn:hover {
            background: var(--color-accent);
            color: white;
            border-color: var(--color-accent);
        }

        .shortcut-delete-btn {
            color: #e53935;
            border-color: rgba(229, 57, 53, 0.2);
        }

        .shortcut-delete-btn:hover {
            background: #e53935;
            color: white;
            border-color: #e53935;
        }

        .shortcut-add-btn {
            width: 100%;
            padding: 1rem;
            border: 2px dashed rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.3);
            color: var(--color-text-subtle);
            font-size: 0.9rem;
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .shortcut-add-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .shortcut-add-btn::before {
            content: "+";
            font-size: 1.2em;
        }

        /* Data management section styling */
        .data-management-section {
            grid-column: 1 / -1;
        }

        .data-management-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .data-btn {
            padding: 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.5);
            color: var(--color-text);
            font-size: 0.9rem;
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .data-btn:hover {
            background: var(--color-accent);
            color: white;
            border-color: var(--color-accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .export-btn::before {
            content: "↓";
        }

        .import-btn::before {
            content: "↑";
        }

        /* Save button container */
        .save-button-container {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }

        .save-button {
            padding: 1rem 2.5rem;
            background: var(--color-accent);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 200px;
        }

        .save-button:hover {
            background: var(--color-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        html.dark-mode .save-button {
            background: #505050;
        }

        html.dark-mode .save-button:hover {
            background: #707070;
        }

        /* Toggle switch styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--color-accent);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Select styling */
        .settings-select {
            padding: 0.7rem 1rem;
            font-size: 0.9rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--color-text);
            transition: all 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(var(--color-accent-rgb), 0.1);
        }

        html.dark-mode .settings-select {
            background-color: rgba(40, 40, 40, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        /* Shortcut editor modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-speed);
            backdrop-filter: blur(3px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--color-background);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            transition: transform var(--transition-speed);
        }

        html.dark-mode .modal-content {
            background-color: #222;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: var(--font-weight-bold);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--color-text-subtle);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
            color: var(--color-text);
        }

        html.dark-mode .form-label {
            color: #e0e0e0;
        }

        .form-input {
            padding: 0.7rem 1rem;
            font-size: 0.9rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--color-text);
            transition: all 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(var(--color-accent-rgb), 0.1);
        }

        html.dark-mode .form-input {
            background-color: rgba(40, 40, 40, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .form-input.key-input {
            width: 3rem;
            text-align: center;
            text-transform: lowercase;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .modal-btn {
            padding: 0.5rem 1rem;
            font-family: var(--font-family);
            font-size: 0.85rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .modal-btn-cancel {
            background-color: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--color-text);
        }

        html.dark-mode .modal-btn-cancel {
            border-color: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .modal-btn-cancel:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        html.dark-mode .modal-btn-cancel:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .modal-btn-save {
            background-color: var(--color-accent);
            border: none;
            color: white;
        }

        html.dark-mode .modal-btn-save {
            background-color: #505050;
        }

        .modal-btn-save:hover {
            background-color: var(--color-hover);
        }

        html.dark-mode .modal-btn-save:hover {
            background-color: #707070;
        }

        /* Import input styling */
        .import-input {
            display: none;
        }

        /* Import file modal */
        .import-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-speed);
        }

        .import-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .import-modal-content {
            background-color: var(--color-background);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            transition: transform var(--transition-speed);
        }

        html.dark-mode .import-modal-content {
            background-color: #222;
        }

        .import-modal-overlay.active .import-modal-content {
            transform: translateY(0);
        }

        .import-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .import-modal-title {
            font-size: 1.2rem;
            font-weight: var(--font-weight-bold);
            margin: 0;
        }

        .import-modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--color-text-subtle);
        }

        .import-text-area {
            width: 100%;
            min-height: 150px;
            padding: 0.8rem;
            font-family: var(--font-family);
            font-size: 0.85rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--color-text);
            box-sizing: border-box;
            margin-bottom: 1rem;
            resize: vertical;
        }

        html.dark-mode .import-text-area {
            background-color: rgba(40, 40, 40, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .import-text-area:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .import-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .import-error {
            color: #e53935;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        .import-error.active {
            display: block;
        }

        /* Import file container styling */
        .import-file-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .import-file-input {
            display: none;
        }

        .import-file-label {
            padding: 0.5rem 1rem;
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: var(--font-family);
            font-size: 0.85rem;
            color: var(--color-text);
            transition: all var(--transition-speed);
        }

        .import-file-label:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }

        html.dark-mode .import-file-label {
            background-color: rgba(40, 40, 40, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        html.dark-mode .import-file-label:hover {
            background-color: rgba(60, 60, 60, 0.9);
        }

        .import-file-name {
            margin-left: 0.5rem;
            font-size: 0.85rem;
            color: var(--color-text-subtle);
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Import divider styling */
        .import-divider {
            text-align: center;
            margin: 1rem 0;
            position: relative;
        }

        .import-divider:before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: 0;
        }

        html.dark-mode .import-divider:before {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .import-divider span {
            position: relative;
            padding: 0 1rem;
            background-color: var(--color-background);
            color: var(--color-text-subtle);
            font-size: 0.85rem;
            z-index: 1;
        }

        /* Color picker styling */
        .color-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .color-option {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .color-option-label {
            font-size: 0.9rem;
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
        }

        .color-option-description {
            font-size: 0.8rem;
            color: var(--color-text-subtle);
            margin-bottom: 0.5rem;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .color-picker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
            width: 50px;
            height: 50px;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker::-webkit-color-swatch {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        html.dark-mode .color-picker::-webkit-color-swatch {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .color-picker-input {
            flex: 1;
            padding: 0.7rem 1rem;
            font-size: 0.9rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--color-text);
        }

        html.dark-mode .color-picker-input {
            background-color: rgba(40, 40, 40, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .color-reset-btn {
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            color: var(--color-text);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-reset-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        html.dark-mode .color-reset-btn {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        html.dark-mode .color-reset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .color-preview {
            width: 100%;
            height: 100px;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-image: linear-gradient(135deg, var(--preview-background-color, #f8f5e6), var(--preview-background-secondary-color, #f2edd0));
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        html.dark-mode .color-preview {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .preview-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--preview-text-color, #222222);
            font-weight: var(--font-weight-bold);
            font-size: 1rem;
        }

        .preview-accent {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 50px;
            height: 20px;
            background-color: var(--preview-accent-color, #333333);
            border-radius: 4px;
        }

        /* RSS Feeds Settings Styles */
        .rss-feeds-container {
            margin-top: 1rem;
        }
        
        .rss-feeds-textarea {
            width: 90%;
            height: 120px;
            padding: 0.75rem;
            font-family: var(--font-family);
            font-size: 0.9rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            resize: vertical;
            background-color: rgba(255, 255, 255, 0.7);
            transition: border-color 0.2s ease;
        }
        
        .dark-mode .rss-feeds-textarea {
            background-color: rgba(30, 30, 30, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
        }
        
        .rss-feeds-textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }
        
        .rss-feeds-suggestions {
            margin-top: 1rem;
        }
        
        .rss-feeds-suggestions h3 {
            font-size: 0.9rem;
            margin: 0 0 0.5rem 0;
            font-weight: 500;
        }
        
        .suggestion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .suggestion-btn {
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius);
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .dark-mode .suggestion-btn {
            background-color: rgba(50, 50, 50, 0.5);
            border-color: rgba(255, 255, 255, 0.05);
        }
        
        .suggestion-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode .suggestion-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <a href="/home" class="back-link">Back to Home</a>
    
    <div class="settings-container">
        <div class="settings-header">
            <div class="settings-header-content">
            <h1 class="settings-title">Settings</h1>
            <p class="settings-description">Customize your homepage experience</p>
            </div>
        </div>

        <div class="settings-section">
            <h2 class="settings-section-title">Appearance</h2>
            
            <div class="settings-option">
                <div>
                    <span class="settings-option-label">Dark mode</span>
                    <span class="settings-option-description">Switch between light and dark theme</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="dark-mode-setting">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="settings-option">
                <div>
                    <span class="settings-option-label">Theme</span>
                    <span class="settings-option-description">Choose a design theme for your homepage</span>
                </div>
                <select id="theme-select" class="settings-select">
                    <option value="default">Default</option>
                    <option value="minimal">Minimal</option>
                    <option value="glass">Glass Modern</option>
                    <option value="ocean">Ocean</option>
                    <option value="swiss">Swiss</option>
                    <option value="custom">Custom</option>
                </select>
            </div>

            <div class="settings-option">
                <div>
                    <span class="settings-option-label">Corner Text</span>
                    <span class="settings-option-description">Text displayed in the bottom right corner</span>
                </div>
                <input type="text" id="corner-text-setting" class="settings-select" placeholder="Enter corner text">
            </div>
        </div>
        
        <!-- New separate section for color customization -->
        <div class="settings-section" id="colors-section" style="display: none;">
            <h2 class="settings-section-title">Color Customization</h2>
            <p class="settings-option-description" style="margin-bottom: 1rem;">
                Customize the colors of your homepage. Changes will be applied on top of your selected theme.
            </p>
            
            <div class="settings-option">
                <div>
                    <span class="settings-option-label">Use Custom Colors</span>
                    <span class="settings-option-description">Enable to use your custom colors instead of theme defaults</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="custom-colors-setting">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div id="custom-colors-container">
                <div class="color-options">
                    <div class="color-option">
                        <span class="color-option-label">Background Color</span>
                        <span class="color-option-description">Main background color</span>
                        <div class="color-picker-container">
                            <input type="color" id="background-color" class="color-picker">
                            <input type="text" id="background-color-text" class="color-picker-input" placeholder="#f8f5e6">
                        </div>
                    </div>
                    
                    <div class="color-option">
                        <span class="color-option-label">Background Secondary</span>
                        <span class="color-option-description">Secondary color for gradient</span>
                        <div class="color-picker-container">
                            <input type="color" id="background-secondary-color" class="color-picker">
                            <input type="text" id="background-secondary-color-text" class="color-picker-input" placeholder="#f2edd0">
                        </div>
                    </div>
                </div>
                
                <div class="color-options">
                    <div class="color-option">
                        <span class="color-option-label">Text Color</span>
                        <span class="color-option-description">Main text color</span>
                        <div class="color-picker-container">
                            <input type="color" id="text-color" class="color-picker">
                            <input type="text" id="text-color-text" class="color-picker-input" placeholder="#222222">
                        </div>
                    </div>
                    
                    <div class="color-option">
                        <span class="color-option-label">Accent Color</span>
                        <span class="color-option-description">Color for buttons and highlights</span>
                        <div class="color-picker-container">
                            <input type="color" id="accent-color" class="color-picker">
                            <input type="text" id="accent-color-text" class="color-picker-input" placeholder="#333333">
                        </div>
                    </div>
                </div>
                
                <button type="button" id="reset-colors" class="color-reset-btn">Reset to Theme Colors</button>
                
                <div class="color-preview">
                    <div class="preview-text">Preview Text</div>
                    <div class="preview-accent"></div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h2 class="settings-section-title">Behavior</h2>
            
            <div class="settings-option">
                <div>
                    <span class="settings-option-label">Open links in new tab</span>
                    <span class="settings-option-description">Controls whether links open in the same window or a new tab</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="new-tab-setting">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- RSS Feeds configuration section -->
        <div class="settings-section">
            <h2 class="settings-section-title">RSS Feeds</h2>
            <p class="settings-option-description" style="margin-bottom: 1rem;">Configure RSS feeds to display in the news section</p>
            
            <div class="rss-feeds-container">
                <textarea id="rss-feeds" class="rss-feeds-textarea" placeholder="Enter RSS feed URLs, one per line
Example: https://news.ycombinator.com/rss
Example: https://www.theverge.com/rss/index.xml"></textarea>
                
                <div class="rss-feeds-suggestions">
                    <h3>Common RSS feeds:</h3>
                    <div class="suggestion-buttons">
                        <button class="suggestion-btn" data-url="https://hnrss.org/frontpage">Hacker News</button>
                        <button class="suggestion-btn" data-url="https://www.theverge.com/rss/index.xml">The Verge</button>
                        <button class="suggestion-btn" data-url="https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml">New York Times</button>
                        <button class="suggestion-btn" data-url="https://feeds.bbci.co.uk/news/world/rss.xml">BBC News</button>
                        <button class="suggestion-btn" data-url="https://feeds.arstechnica.com/arstechnica/index">Ars Technica</button>
                        <button class="suggestion-btn" data-url="https://www.repubblica.it/rss/homepage/rss2.0.xml">La Repubblica</button>
                        <button class="suggestion-btn" data-url="https://www.ilsole24ore.com/rss/italia.xml">Il Sole 24 Ore</button>
                        <button class="suggestion-btn" data-url="https://www.corriere.it/rss/homepage.xml">Corriere della Sera</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section shortcuts-section">
            <h2 class="settings-section-title">Shortcuts</h2>
            <p class="settings-option-description" style="margin-bottom: 1rem;">Manage your homepage shortcuts</p>
            
            <ul class="shortcuts-list" id="shortcuts-list">
                <!-- Shortcuts will be populated here by JavaScript -->
            </ul>
            
            <button type="button" id="add-shortcut" class="shortcut-add-btn">+ Add New Shortcut</button>
        </div>

        <div class="settings-section data-management-section">
            <h2 class="settings-section-title">Data Management</h2>
            <p class="settings-option-description" style="margin-bottom: 1rem;">Export or import your settings and shortcuts</p>
            
            <div class="data-management-buttons">
                <button type="button" id="export-settings" class="data-btn export-btn">Export Settings</button>
                <button type="button" id="import-settings" class="data-btn import-btn">Import Settings</button>
            </div>
        </div>

        <div class="save-button-container">
        <button type="button" id="save-settings" class="save-button">Save Settings</button>
        </div>
    </div>

    <!-- Shortcut Editor Modal -->
    <div class="modal-overlay" id="shortcut-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add Shortcut</h3>
                <button type="button" class="modal-close" id="modal-close">&times;</button>
            </div>
            <form id="shortcut-form">
                <div class="form-group">
                    <label for="shortcut-key" class="form-label">Key (single character)</label>
                    <input type="text" id="shortcut-key" class="form-input key-input" maxlength="1" required>
                </div>
                <div class="form-group">
                    <label for="shortcut-name" class="form-label">Name</label>
                    <input type="text" id="shortcut-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="shortcut-url" class="form-label">URL</label>
                    <input type="url" id="shortcut-url" class="form-input" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-cancel" id="modal-cancel">Cancel</button>
                    <button type="submit" class="modal-btn modal-btn-save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Settings Modal -->
    <div class="import-modal-overlay" id="import-modal">
        <div class="import-modal-content">
            <div class="import-modal-header">
                <h3 class="import-modal-title">Import Settings</h3>
                <button type="button" class="import-modal-close" id="import-modal-close">&times;</button>
            </div>
            <div>
                <p class="settings-option-description" style="margin-bottom: 1rem;">Upload your settings file or paste the JSON data below</p>
                
                <div class="import-file-container">
                    <input type="file" id="import-file-input" class="import-file-input" accept=".json">
                    <label for="import-file-input" class="import-file-label">Select JSON File</label>
                    <span id="import-file-name" class="import-file-name"></span>
                </div>
                
                <div class="import-divider">
                    <span>or</span>
                </div>
                
                <textarea id="import-data" class="import-text-area" placeholder="Paste JSON settings data here..."></textarea>
                <div id="import-error" class="import-error">Invalid data format. Please use a valid settings JSON file.</div>
            </div>
            <div class="import-modal-actions">
                <button type="button" class="modal-btn modal-btn-cancel" id="import-modal-cancel">Cancel</button>
                <button type="button" class="modal-btn modal-btn-save" id="import-modal-apply">Apply</button>
            </div>
        </div>
    </div>

    <script>
        // Theme definitions - same as in the widget to ensure consistency
        const THEMES = {
            default: {
                light: {
                    background: '#f8f5e6',
                    gradient: 'linear-gradient(135deg, #f8f5e6, #f2edd0)',
                    text: '#222222',
                    textSubtle: '#666666',
                    accent: '#333333',
                    hover: '#444444',
                    boxShadow: '0 1px 4px rgba(0, 0, 0, 0.03)'
                },
                dark: {
                    background: '#1a1a1a',
                    gradient: 'linear-gradient(135deg, #222, #333)',
                    text: '#e0e0e0',
                    textSubtle: '#a0a0a0',
                    accent: '#505050',
                    hover: '#707070',
                    boxShadow: '0 1px 4px rgba(0, 0, 0, 0.2)'
                }
            },
            minimal: {
                light: {
                    background: '#ffffff',
                    gradient: 'none',
                    text: '#000000',
                    textSubtle: '#999999',
                    accent: '#cccccc',
                    hover: '#eeeeee',
                    boxShadow: 'none',
                    borderRadius: '0',
                    borderWidth: '0',
                    fontFamily: '"Courier New", monospace',
                    fontSize: '12px',
                    commandsBackground: 'transparent',
                    commandsBorder: 'none',
                    commandsBoxShadow: 'none',
                    commandMaxWidth: '70rem',
                    keyColor: '#666666'
                },
                dark: {
                    background: '#000000',
                    gradient: 'none',
                    text: '#ffffff',
                    textSubtle: '#777777',
                    accent: '#333333',
                    hover: '#222222',
                    boxShadow: 'none',
                    borderRadius: '0',
                    borderWidth: '0',
                    fontFamily: '"Courier New", monospace',
                    fontSize: '12px',
                    commandsBackground: 'transparent',
                    commandsBorder: 'none',
                    commandsBoxShadow: 'none',
                    commandMaxWidth: '70rem',
                    keyColor: '#999999'
                }
            },
            swiss: {
                light: {
                    background: '#ffffff',
                    gradient: 'none',
                    text: '#111111',
                    textSubtle: '#666666',
                    accent: '#ff3b30',
                    hover: '#ff6651',
                    boxShadow: 'none',
                    borderRadius: '0',
                    borderWidth: '0',
                    fontFamily: '"Helvetica Neue", Arial, sans-serif',
                    fontSize: '13px',
                    fontWeight: '300',
                    commandsBackground: 'transparent',
                    commandsBorder: 'none',
                    commandsBoxShadow: 'none',
                    commandMaxWidth: '80rem',
                    keyColor: '#ff3b30',
                    nameSpacing: '0.05em',
                    gridLayout: 'true',
                    letterSpacing: '0.03em',
                    keyFontSize: '1.1em',
                    keyWeight: '700',
                    nameAfterHeight: '0',
                    nameHoverColor: '#ff3b30'
                },
                dark: {
                    background: '#000000',
                    gradient: 'none',
                    text: '#ffffff',
                    textSubtle: '#999999',
                    accent: '#ff3b30',
                    hover: '#ff6651',
                    boxShadow: 'none',
                    borderRadius: '0',
                    borderWidth: '0',
                    fontFamily: '"Helvetica Neue", Arial, sans-serif',
                    fontSize: '13px',
                    fontWeight: '300',
                    commandsBackground: 'transparent',
                    commandsBorder: 'none',
                    commandsBoxShadow: 'none',
                    commandMaxWidth: '80rem',
                    keyColor: '#ff3b30',
                    nameSpacing: '0.05em',
                    gridLayout: 'true',
                    letterSpacing: '0.03em',
                    keyFontSize: '1.1em',
                    keyWeight: '700',
                    nameAfterHeight: '0',
                    nameHoverColor: '#ff3b30',
                    cornerTextTransform: 'uppercase',
                    cornerTextSpacing: '0.1em',
                    cornerTextWeight: '400',
                    cornerTextSize: '0.65rem'
                }
            },
            glass: {
                light: {
                    background: 'rgba(255, 255, 255, 0.7)',
                    gradient: 'linear-gradient(135deg, #f5f7fa, #c3cfe2)',
                    text: '#334155',
                    textSubtle: '#64748b',
                    accent: '#3b82f6',
                    hover: '#60a5fa',
                    boxShadow: '0 4px 20px rgba(0, 0, 0, 0.05)',
                    borderRadius: '16px',
                    commandsBackground: 'rgba(255, 255, 255, 0.6)',
                    commandsBorder: '1px solid rgba(255, 255, 255, 0.2)',
                    commandsBoxShadow: '0 8px 32px rgba(0, 0, 0, 0.07)',
                    fontFamily: '"Inter", -apple-system, BlinkMacSystemFont, sans-serif',
                    fontSize: '14px',
                    keyColor: '#3b82f6',
                    commandMaxWidth: '60rem',
                    backdropFilter: 'blur(10px)',
                    cornerTextStyle: 'text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.6rem; font-weight: 500;',
                    dotSize: '6px',
                    dotOpacity: '0.7',
                    nameAfterHeight: '2px'
                },
                dark: {
                    background: 'rgba(15, 23, 42, 0.7)',
                    gradient: 'linear-gradient(135deg, #0f172a, #1e293b)',
                    text: '#e2e8f0',
                    textSubtle: '#94a3b8',
                    accent: '#38bdf8',
                    hover: '#7dd3fc',
                    boxShadow: '0 4px 20px rgba(0, 0, 0, 0.2)',
                    borderRadius: '16px',
                    commandsBackground: 'rgba(30, 41, 59, 0.5)',
                    commandsBorder: '1px solid rgba(255, 255, 255, 0.1)',
                    commandsBoxShadow: '0 8px 32px rgba(0, 0, 0, 0.2)',
                    fontFamily: '"Inter", -apple-system, BlinkMacSystemFont, sans-serif',
                    fontSize: '14px',
                    keyColor: '#38bdf8',
                    commandMaxWidth: '60rem',
                    backdropFilter: 'blur(10px)',
                    cornerTextStyle: 'text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.6rem; font-weight: 500;',
                    dotSize: '6px',
                    dotOpacity: '0.7',
                    nameAfterHeight: '2px'
                }
            },
            ocean: {
                light: {
                    background: '#e0f7fa',
                    gradient: 'linear-gradient(135deg, #e0f7fa, #80deea 50%, #4dd0e1)',
                    text: '#006064',
                    textSubtle: '#0097a7',
                    accent: '#00838f',
                    hover: '#006064',
                    boxShadow: '0 4px 14px rgba(0, 131, 143, 0.15)',
                    borderRadius: '12px',
                    commandsBackground: 'rgba(224, 247, 250, 0.8)',
                    commandsBorder: '1px solid rgba(129, 212, 250, 0.4)',
                    commandsBoxShadow: '0 6px 24px rgba(0, 131, 143, 0.1)',
                    fontFamily: '"Inter", -apple-system, BlinkMacSystemFont, sans-serif',
                    fontSize: '14px',
                    keyColor: '#00acc1',
                    commandMaxWidth: '55rem',
                    backdropFilter: 'blur(8px)',
                    cornerTextStyle: 'font-style: italic; letter-spacing: 0.05em; font-size: 0.7rem;',
                    dotSize: '8px',
                    dotOpacity: '0.8',
                    nameAfterHeight: '2px',
                    nameFont: '500',
                    commandsColumns: '3',
                    inputBackground: 'rgba(224, 247, 250, 0.9)',
                    inputBorder: '1px solid rgba(129, 212, 250, 0.5)',
                    inputShadow: '0 2px 10px rgba(0, 131, 143, 0.1)',
                    uiAnimation: 'true',
                    cornerTextOpacity: '0.85'
                },
                dark: {
                    background: '#002f35',
                    gradient: 'linear-gradient(135deg, #002f35, #00363a 50%, #004d40)',
                    text: '#e0f7fa',
                    textSubtle: '#80deea',
                    accent: '#26c6da',
                    hover: '#4dd0e1',
                    boxShadow: '0 4px 14px rgba(0, 172, 193, 0.2)',
                    borderRadius: '12px',
                    commandsBackground: 'rgba(0, 59, 66, 0.7)',
                    commandsBorder: '1px solid rgba(38, 198, 218, 0.2)',
                    commandsBoxShadow: '0 6px 24px rgba(0, 172, 193, 0.15)',
                    fontFamily: '"Inter", -apple-system, BlinkMacSystemFont, sans-serif',
                    fontSize: '14px',
                    keyColor: '#26c6da',
                    commandMaxWidth: '55rem',
                    backdropFilter: 'blur(8px)',
                    cornerTextStyle: 'font-style: italic; letter-spacing: 0.05em; font-size: 0.7rem;',
                    dotSize: '8px',
                    dotOpacity: '0.8',
                    nameAfterHeight: '2px',
                    nameFont: '500',
                    commandsColumns: '3',
                    inputBackground: 'rgba(0, 59, 66, 0.8)',
                    inputBorder: '1px solid rgba(38, 198, 218, 0.3)',
                    inputShadow: '0 2px 10px rgba(0, 172, 193, 0.15)',
                    uiAnimation: 'true',
                    cornerTextOpacity: '0.85'
                }
            }
        };

        // Variables to store settings and commands
        let currentSettings = {
            openLinksInNewTab: false,
            darkMode: false,
            theme: 'default',
            cornerText: '',
            customColors: {
                background: '#f8f5e6',
                backgroundSecondary: '#f2edd0',
                text: '#222222',
                accent: '#333333'
            },
            useCustomColors: false  // New flag to track if custom colors should be used
        };
        
        let commands = new Map();
        let editingKey = null;

        // DOM Elements
        const darkModeSetting = document.getElementById('dark-mode-setting');
        const themeSelect = document.getElementById('theme-select');
        const newTabSetting = document.getElementById('new-tab-setting');
        const cornerTextSetting = document.getElementById('corner-text-setting');
        const saveButton = document.getElementById('save-settings');
        const shortcutsList = document.getElementById('shortcuts-list');
        const addShortcutButton = document.getElementById('add-shortcut');
        
        // Modal Elements
        const shortcutModal = document.getElementById('shortcut-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalCloseButton = document.getElementById('modal-close');
        const modalCancelButton = document.getElementById('modal-cancel');
        const shortcutForm = document.getElementById('shortcut-form');
        const shortcutKeyInput = document.getElementById('shortcut-key');
        const shortcutNameInput = document.getElementById('shortcut-name');
        const shortcutUrlInput = document.getElementById('shortcut-url');

        // Import/Export Elements
        const exportBtn = document.getElementById('export-settings');
        const importBtn = document.getElementById('import-settings');
        const importModal = document.getElementById('import-modal');
        const importModalClose = document.getElementById('import-modal-close');
        const importModalCancel = document.getElementById('import-modal-cancel');
        const importModalApply = document.getElementById('import-modal-apply');
        const importDataTextarea = document.getElementById('import-data');
        const importError = document.getElementById('import-error');
        const importFileInput = document.getElementById('import-file-input');
        const importFileName = document.getElementById('import-file-name');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadCommands();
            renderShortcuts();
            
            // Apply current theme
            applyTheme(currentSettings.theme, currentSettings.darkMode, currentSettings.useCustomColors);
            
            // Add event listeners
            darkModeSetting.addEventListener('change', onDarkModeChange);
            themeSelect.addEventListener('change', onThemeChange);
            newTabSetting.addEventListener('change', onNewTabChange);
            cornerTextSetting.addEventListener('change', (e) => {
                currentSettings.cornerText = e.target.value.trim();
            });
            
            // Add event listener for custom colors toggle
            const customColorsToggle = document.getElementById('custom-colors-setting');
            customColorsToggle.addEventListener('change', (e) => {
                currentSettings.useCustomColors = e.target.checked;
                applyTheme(currentSettings.theme, currentSettings.darkMode, currentSettings.useCustomColors);
                
                // Highlight the colors section if custom colors are enabled
                const colorsSection = document.getElementById('colors-section');
                if (currentSettings.useCustomColors) {
                    colorsSection.style.border = '2px solid var(--color-accent)';
                    colorsSection.style.padding = '1.5rem';
                    colorsSection.style.borderRadius = 'var(--border-radius)';
                    colorsSection.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                } else {
                    colorsSection.style.border = '';
                    colorsSection.style.padding = '';
                    colorsSection.style.borderRadius = '';
                    colorsSection.style.boxShadow = '';
                }
            });
            
            saveButton.addEventListener('click', saveSettings);
            
            // Shortcut modal event listeners
            addShortcutButton.addEventListener('click', openAddShortcutModal);
            modalCloseButton.addEventListener('click', closeModal);
            modalCancelButton.addEventListener('click', closeModal);
            shortcutForm.addEventListener('submit', onShortcutSave);
            
            // Export/Import event listeners
            exportBtn.addEventListener('click', exportSettings);
            importBtn.addEventListener('click', openImportModal);
            importModalClose.addEventListener('click', closeImportModal);
            importModalCancel.addEventListener('click', closeImportModal);
            importModalApply.addEventListener('click', importSettings);
            importFileInput.addEventListener('change', handleFileSelect);
            
            // Color picker event listeners
            setupColorPickers();

            // Add RSS feed suggestion buttons functionality
            const suggestionButtons = document.querySelectorAll('.suggestion-btn');
            const rssFeedsTextarea = document.getElementById('rss-feeds');
            
            suggestionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const url = this.getAttribute('data-url');
                    
                    // Get current feeds
                    const currentFeeds = rssFeedsTextarea.value
                        .split('\n')
                        .map(feed => feed.trim())
                        .filter(feed => feed !== '');
                    
                    // Check if already added
                    if (!currentFeeds.includes(url)) {
                        // Add to textarea
                        if (currentFeeds.length > 0) {
                            rssFeedsTextarea.value = currentFeeds.join('\n') + '\n' + url;
                        } else {
                            rssFeedsTextarea.value = url;
                        }
                        
                        // Show feedback
                        button.innerText = '✓ Added';
                        button.style.backgroundColor = 'rgba(0, 200, 0, 0.2)';
                        
                        // Reset after 1 second
                        setTimeout(() => {
                            button.innerText = button.getAttribute('data-original-text') || 
                                              button.innerText.replace('✓ Added', '');
                            button.style.backgroundColor = '';
                        }, 1000);
                    } else {
                        // Already added - show feedback
                        button.innerText = 'Already added';
                        
                        // Reset after 1 second
                        setTimeout(() => {
                            button.innerText = button.getAttribute('data-original-text') || button.innerText.replace('Already added', button.innerText);
                        }, 1000);
                    }
                });
                
                // Store original text
                button.setAttribute('data-original-text', button.innerText);
            });
        });

        // Load settings from localStorage
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('homeSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    
                    // Update current settings
                    currentSettings = {
                        openLinksInNewTab: settings.openLinksInNewTab || false,
                        darkMode: settings.darkMode || false,
                        theme: settings.theme || 'default',
                        cornerText: settings.cornerText || '',
                        customColors: settings.customColors || {
                            background: '#f8f5e6',
                            backgroundSecondary: '#f2edd0',
                            text: '#222222',
                            accent: '#333333'
                        },
                        useCustomColors: settings.useCustomColors || false
                    };
                    
                    // Update form elements
                    darkModeSetting.checked = currentSettings.darkMode;
                    themeSelect.value = currentSettings.theme;
                    newTabSetting.checked = currentSettings.openLinksInNewTab;
                    cornerTextSetting.value = currentSettings.cornerText;
                    
                    // Set custom colors toggle
                    const customColorsToggle = document.getElementById('custom-colors-setting');
                    customColorsToggle.checked = currentSettings.useCustomColors;
                    
                    // Highlight the colors section if custom colors are enabled
                    const colorsSection = document.getElementById('colors-section');
                    if (currentSettings.useCustomColors) {
                        colorsSection.style.border = '2px solid var(--color-accent)';
                        colorsSection.style.padding = '1.5rem';
                        colorsSection.style.borderRadius = 'var(--border-radius)';
                        colorsSection.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                    }
                    
                    // Update color pickers
                    if (currentSettings.customColors) {
                        updateColorPickers(currentSettings.customColors);
                    }
                    
                    // Load RSS feeds
                    if (settings.rssFeeds && Array.isArray(settings.rssFeeds)) {
                        document.getElementById('rss-feeds').value = settings.rssFeeds.join('\n');
                    }
                    
                    console.log("Settings loaded:", currentSettings);
                }
            } catch (e) {
                console.error('Error loading settings:', e);
                // Show error message on the page
                const errorMsg = document.createElement('div');
                errorMsg.style.color = 'red';
                errorMsg.style.padding = '1rem';
                errorMsg.style.marginTop = '1rem';
                errorMsg.style.border = '1px solid red';
                errorMsg.textContent = 'Error loading settings: ' + e.message;
                document.querySelector('.settings-container').appendChild(errorMsg);
            }
        }

        // Load commands from localStorage
        function loadCommands() {
            try {
                const savedCommands = localStorage.getItem('homeCommands');
                if (savedCommands) {
                    const commandsArray = JSON.parse(savedCommands);
                    commands = new Map(commandsArray);
                } else {
                    // Default commands
                    commands = new Map([
                        ['a', { name: 'Plex', url: 'https://app.plex.tv/desktop/' }],
                        ['g', { name: 'Google', url: 'https://google.com' }],
                        ['y', { name: 'YouTube', url: 'https://youtube.com/' }],
                    ]);
                }
            } catch (e) {
                console.error('Error loading commands:', e);
            }
        }

        // Render the shortcuts list
        function renderShortcuts() {
            shortcutsList.innerHTML = '';
            
            // Sort commands alphabetically by key
            const sortedCommands = Array.from(commands.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            
            for (const [key, command] of sortedCommands) {
                const li = document.createElement('li');
                li.className = 'shortcut-item';
                li.dataset.key = key;
                
                const info = document.createElement('div');
                info.className = 'shortcut-info';
                
                const keySpan = document.createElement('span');
                keySpan.className = 'shortcut-key';
                keySpan.textContent = key;
                
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'shortcut-details';
                
                const nameSpan = document.createElement('div');
                nameSpan.className = 'shortcut-name';
                nameSpan.textContent = command.name;
                
                const urlSpan = document.createElement('div');
                urlSpan.className = 'shortcut-url';
                urlSpan.textContent = command.url;
                
                detailsDiv.appendChild(nameSpan);
                detailsDiv.appendChild(urlSpan);
                
                info.appendChild(keySpan);
                info.appendChild(detailsDiv);
                
                const actions = document.createElement('div');
                actions.className = 'shortcut-actions';
                
                const editButton = document.createElement('button');
                editButton.type = 'button';
                editButton.className = 'shortcut-edit-btn';
                editButton.textContent = 'Edit';
                editButton.addEventListener('click', () => openEditShortcutModal(key));
                
                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'shortcut-delete-btn';
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => deleteShortcut(key));
                
                actions.appendChild(editButton);
                actions.appendChild(deleteButton);
                
                li.appendChild(info);
                li.appendChild(actions);
                
                shortcutsList.appendChild(li);
            }
        }

        // Dark mode toggle handler
        function onDarkModeChange(e) {
            const isDarkMode = e.target.checked;
            applyTheme(currentSettings.theme, isDarkMode, currentSettings.useCustomColors);
            currentSettings.darkMode = isDarkMode;
            
            // Update color pickers to reflect the current theme's colors in the new mode
            const themeColors = getThemeColors(currentSettings.theme, isDarkMode);
            updateColorPreview(currentSettings.useCustomColors ? currentSettings.customColors : themeColors);
        }

        // Theme change handler
        function onThemeChange(e) {
            const theme = e.target.value;
            currentSettings.theme = theme;
            applyTheme(theme, currentSettings.darkMode, currentSettings.useCustomColors);
            
            // Update color pickers to reflect the current theme's colors
            const themeColors = getThemeColors(theme, currentSettings.darkMode);
            updateColorPickers(themeColors);
            updateColorPreview(currentSettings.useCustomColors ? currentSettings.customColors : themeColors);
        }

        // New tab setting handler
        function onNewTabChange(e) {
            currentSettings.openLinksInNewTab = e.target.checked;
        }

        // Setup color pickers
        function setupColorPickers() {
            const backgroundColorPicker = document.getElementById('background-color');
            const backgroundColorText = document.getElementById('background-color-text');
            const backgroundSecondaryColorPicker = document.getElementById('background-secondary-color');
            const backgroundSecondaryColorText = document.getElementById('background-secondary-color-text');
            const textColorPicker = document.getElementById('text-color');
            const textColorText = document.getElementById('text-color-text');
            const accentColorPicker = document.getElementById('accent-color');
            const accentColorText = document.getElementById('accent-color-text');
            const resetColorsBtn = document.getElementById('reset-colors');
            const colorPreview = document.querySelector('.color-preview');
            
            // Set initial values based on current theme
            const initialThemeColors = getThemeColors(currentSettings.theme, currentSettings.darkMode);
            updateColorPickers(initialThemeColors);
            updateColorPreview(currentSettings.useCustomColors ? currentSettings.customColors : initialThemeColors);
            
            // Add event listeners for color pickers
            backgroundColorPicker.addEventListener('input', (e) => {
                const color = e.target.value;
                backgroundColorText.value = color;
                currentSettings.customColors.background = color;
                if (currentSettings.useCustomColors) {
                    updateColorPreview(currentSettings.customColors);
                    applyTheme(currentSettings.theme, currentSettings.darkMode, true);
                }
            });
            
            backgroundColorText.addEventListener('input', (e) => {
                const color = e.target.value;
                if (isValidColor(color)) {
                    backgroundColorPicker.value = color;
                    currentSettings.customColors.background = color;
                    if (currentSettings.useCustomColors) {
                        updateColorPreview(currentSettings.customColors);
                        applyTheme(currentSettings.theme, currentSettings.darkMode, true);
                    }
                }
            });
            
            backgroundSecondaryColorPicker.addEventListener('input', (e) => {
                const color = e.target.value;
                backgroundSecondaryColorText.value = color;
                currentSettings.customColors.backgroundSecondary = color;
                if (currentSettings.useCustomColors) {
                    updateColorPreview(currentSettings.customColors);
                    applyTheme(currentSettings.theme, currentSettings.darkMode, true);
                }
            });
            
            backgroundSecondaryColorText.addEventListener('input', (e) => {
                const color = e.target.value;
                if (isValidColor(color)) {
                    backgroundSecondaryColorPicker.value = color;
                    currentSettings.customColors.backgroundSecondary = color;
                    if (currentSettings.useCustomColors) {
                        updateColorPreview(currentSettings.customColors);
                        applyTheme(currentSettings.theme, currentSettings.darkMode, true);
                    }
                }
            });
            
            textColorPicker.addEventListener('input', (e) => {
                const color = e.target.value;
                textColorText.value = color;
                currentSettings.customColors.text = color;
                if (currentSettings.useCustomColors) {
                    updateColorPreview(currentSettings.customColors);
                    applyTheme(currentSettings.theme, currentSettings.darkMode, true);
                }
            });
            
            textColorText.addEventListener('input', (e) => {
                const color = e.target.value;
                if (isValidColor(color)) {
                    textColorPicker.value = color;
                    currentSettings.customColors.text = color;
                    if (currentSettings.useCustomColors) {
                        updateColorPreview(currentSettings.customColors);
                        applyTheme(currentSettings.theme, currentSettings.darkMode, true);
                    }
                }
            });
            
            accentColorPicker.addEventListener('input', (e) => {
                const color = e.target.value;
                accentColorText.value = color;
                currentSettings.customColors.accent = color;
                if (currentSettings.useCustomColors) {
                    updateColorPreview(currentSettings.customColors);
                    applyTheme(currentSettings.theme, currentSettings.darkMode, true);
                }
            });
            
            accentColorText.addEventListener('input', (e) => {
                const color = e.target.value;
                if (isValidColor(color)) {
                    accentColorPicker.value = color;
                    currentSettings.customColors.accent = color;
                    if (currentSettings.useCustomColors) {
                        updateColorPreview(currentSettings.customColors);
                        applyTheme(currentSettings.theme, currentSettings.darkMode, true);
                    }
                }
            });
            
            resetColorsBtn.addEventListener('click', () => {
                // Reset to current theme colors
                const themeColors = getThemeColors(currentSettings.theme, currentSettings.darkMode);
                
                currentSettings.customColors = { ...themeColors };
                updateColorPickers(themeColors);
                updateColorPreview(currentSettings.useCustomColors ? themeColors : themeColors);
                
                if (currentSettings.useCustomColors) {
                    applyTheme(currentSettings.theme, currentSettings.darkMode, true);
                }
            });
        }
        
        // Update color pickers with values
        function updateColorPickers(colors) {
            document.getElementById('background-color').value = colors.background;
            document.getElementById('background-color-text').value = colors.background;
            document.getElementById('background-secondary-color').value = colors.backgroundSecondary;
            document.getElementById('background-secondary-color-text').value = colors.backgroundSecondary;
            document.getElementById('text-color').value = colors.text;
            document.getElementById('text-color-text').value = colors.text;
            document.getElementById('accent-color').value = colors.accent;
            document.getElementById('accent-color-text').value = colors.accent;
        }
        
        // Update color preview
        function updateColorPreview(colors) {
            const colorPreview = document.querySelector('.color-preview');
            colorPreview.style.setProperty('--preview-background-color', colors.background);
            colorPreview.style.setProperty('--preview-background-secondary-color', colors.backgroundSecondary);
            colorPreview.style.setProperty('--preview-text-color', colors.text);
            colorPreview.style.setProperty('--preview-accent-color', colors.accent);
        }
        
        // Check if a string is a valid color
        function isValidColor(color) {
            const s = new Option().style;
            s.color = color;
            return s.color !== '';
        }
        
        // Apply custom theme
        function applyCustomTheme(colors, isDarkMode) {
            // Apply basic colors
            document.documentElement.style.setProperty('--color-background', colors.background);
            document.documentElement.style.setProperty('--color-text', colors.text);
            document.documentElement.style.setProperty('--color-accent', colors.accent);
            document.documentElement.style.setProperty('--color-hover', lightenDarkenColor(colors.accent, isDarkMode ? 20 : -20));
            
            // Apply gradient
            document.documentElement.style.backgroundImage = `linear-gradient(135deg, ${colors.background}, ${colors.backgroundSecondary})`;
            
            // Calculate and set subtle text color
            const subtleText = isDarkMode ? lightenDarkenColor(colors.text, -30) : lightenDarkenColor(colors.text, 30);
            document.documentElement.style.setProperty('--color-text-subtle', subtleText);
        }
        
        // Helper function to lighten or darken a color
        function lightenDarkenColor(color, percent) {
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R < 255) ? R : 255;
            G = (G < 255) ? G : 255;
            B = (B < 255) ? B : 255;

            R = (R > 0) ? R : 0;
            G = (G > 0) ? G : 0;
            B = (B > 0) ? B : 0;

            const RR = ((R.toString(16).length === 1) ? "0" + R.toString(16) : R.toString(16));
            const GG = ((G.toString(16).length === 1) ? "0" + G.toString(16) : G.toString(16));
            const BB = ((B.toString(16).length === 1) ? "0" + B.toString(16) : B.toString(16));

            return "#" + RR + GG + BB;
        }
        
        // Apply theme to page
        function applyTheme(themeName, isDarkMode, useCustomColors) {
            // Toggle dark mode class
            document.documentElement.classList.toggle('dark-mode', isDarkMode);
            
            // Store theme data in the document
            document.documentElement.dataset.theme = themeName;
            document.documentElement.dataset.darkMode = isDarkMode;
            
            // Get the base theme colors
            const theme = THEMES[themeName] || THEMES.default;
            const colors = isDarkMode ? theme.dark : theme.light;
            
            // Apply colors - either from theme or custom
            if (useCustomColors) {
                // Apply custom colors on top of theme
                document.documentElement.style.setProperty('--color-background', currentSettings.customColors.background);
                document.documentElement.style.setProperty('--color-text', currentSettings.customColors.text);
                document.documentElement.style.setProperty('--color-accent', currentSettings.customColors.accent);
                document.documentElement.style.setProperty('--color-hover', lightenDarkenColor(currentSettings.customColors.accent, isDarkMode ? 20 : -20));
                
                // Apply gradient with custom colors
                document.documentElement.style.backgroundImage = `linear-gradient(135deg, ${currentSettings.customColors.background}, ${currentSettings.customColors.backgroundSecondary})`;
                
                // Calculate and set subtle text color
                const subtleText = isDarkMode ? lightenDarkenColor(currentSettings.customColors.text, -30) : lightenDarkenColor(currentSettings.customColors.text, 30);
                document.documentElement.style.setProperty('--color-text-subtle', subtleText);
            } else {
                // Apply theme colors
            document.documentElement.style.setProperty('--color-background', colors.background);
            document.documentElement.style.setProperty('--color-text', colors.text);
            document.documentElement.style.setProperty('--color-text-subtle', colors.textSubtle);
            document.documentElement.style.setProperty('--color-accent', colors.accent);
            document.documentElement.style.setProperty('--color-hover', colors.hover);
            document.documentElement.style.setProperty('--box-shadow', colors.boxShadow);
            
            // Apply gradient
            if (colors.gradient && colors.gradient !== 'none') {
                document.documentElement.style.backgroundImage = colors.gradient;
            } else {
                document.documentElement.style.backgroundImage = 'none';
                }
            }
            
            // Always apply theme-specific styles
            if (colors.borderRadius) {
                document.documentElement.style.setProperty('--border-radius', colors.borderRadius);
            } else {
                document.documentElement.style.setProperty('--border-radius', '8px');
            }
            
            if (colors.fontFamily) {
                document.documentElement.style.fontFamily = colors.fontFamily;
            } else {
                document.documentElement.style.fontFamily = 'var(--font-family)';
            }
            
            if (colors.fontSize) {
                document.documentElement.style.fontSize = colors.fontSize;
            } else {
                document.documentElement.style.fontSize = 'var(--font-size)';
            }
            
            // Handle special theme properties
            if (themeName === 'minimal') {
                // Set minimal styles
                document.querySelectorAll('.corner-text').forEach(el => {
                    el.style.opacity = '0';
                });
                
                // Style minimal specific settings
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.style.borderRadius = colors.borderRadius || '0';
                });
                
            } else if (themeName === 'glass') {
                // Apply glass theme properties
                document.documentElement.style.backdropFilter = colors.backdropFilter || 'blur(10px)';
                
                // Style the back link for glass theme
                const backLink = document.querySelector('.back-link');
                if (backLink) {
                    backLink.style.color = colors.accent;
                }
                
                // Style buttons for glass theme
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => {
                    if (btn.classList.contains('save-button')) {
                        btn.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.1)';
                    }
                });
                
            } else if (themeName === 'ocean') {
                // Apply Ocean theme properties
                document.documentElement.style.backdropFilter = colors.backdropFilter || 'blur(8px)';
                
                // Style buttons for ocean theme
                const saveButton = document.querySelector('.save-button');
                if (saveButton) {
                    saveButton.style.boxShadow = colors.boxShadow;
                }
                
                // Apply animations if enabled
                if (colors.uiAnimation === 'true') {
                    const styleElement = document.getElementById('ocean-animations');
                    if (!styleElement) {
                        const style = document.createElement('style');
                        style.id = 'ocean-animations';
                        style.textContent = `
                            .shortcut-item {
                                transition: transform 0.3s ease, box-shadow 0.3s ease !important;
                            }
                            .shortcut-item:hover {
                                transform: translateY(-2px) !important;
                                box-shadow: 0 4px 12px rgba(0, 131, 143, 0.15) !important;
                            }
                            
                            .save-button {
                                transition: all 0.3s ease !important;
                            }
                            .save-button:hover {
                                transform: translateY(-2px);
                                box-shadow: 0 6px 14px rgba(0, 131, 143, 0.2) !important;
                            }
                        `;
                        document.head.appendChild(style);
                    }
                } else {
                    const styleElement = document.getElementById('ocean-animations');
                    if (styleElement) {
                        styleElement.remove();
                    }
                }
                
            } else if (themeName === 'swiss') {
                // Apply Swiss theme properties
                document.documentElement.style.letterSpacing = colors.letterSpacing || '0.03em';
                
                if (colors.fontWeight) {
                    document.documentElement.style.fontWeight = colors.fontWeight;
                }
                
                // Style corner texts for Swiss theme
                document.querySelectorAll('.shortcut-key').forEach(el => {
                    el.style.backgroundColor = useCustomColors ? currentSettings.customColors.accent : colors.accent;
                    el.style.borderRadius = '0';
                });
                
                // Apply Swiss button styles
                document.querySelectorAll('button').forEach(btn => {
                    btn.style.borderRadius = '0';
                    if (btn.classList.contains('save-button')) {
                        btn.style.backgroundColor = useCustomColors ? currentSettings.customColors.accent : colors.accent;
                    }
                });
                
                // Create Swiss style for form elements
                const styleElement = document.getElementById('swiss-style');
                if (!styleElement) {
                    const style = document.createElement('style');
                    style.id = 'swiss-style';
                    style.textContent = `
                        .settings-select, .form-input {
                            border-radius: 0 !important;
                        }
                        .shortcut-item {
                            border-radius: 0 !important;
                            border-left: 2px solid transparent;
                            transition: all 0.2s ease;
                        }
                        .shortcut-item:hover {
                            border-left-color: ${useCustomColors ? currentSettings.customColors.accent : colors.accent};
                        }
                    `;
                    document.head.appendChild(style);
                }
            } else {
                // Reset to default styles for other themes
                document.documentElement.style.backdropFilter = 'none';
                document.documentElement.style.letterSpacing = '';
                document.documentElement.style.fontWeight = '';
                
                // Remove theme-specific style elements
                const oceanStyles = document.getElementById('ocean-animations');
                if (oceanStyles) oceanStyles.remove();
                
                const swissStyles = document.getElementById('swiss-style');
                if (swissStyles) swissStyles.remove();
                
                // Reset any styled elements
                document.querySelectorAll('.shortcut-key').forEach(el => {
                    el.style.borderRadius = '';
                    el.style.backgroundColor = '';
                });
                
                document.querySelectorAll('button').forEach(btn => {
                    btn.style.borderRadius = '';
                    btn.style.boxShadow = '';
                    btn.style.backgroundColor = '';
                });
            }
            
            // Dispatch theme changed event for other components
            document.dispatchEvent(new CustomEvent('themeChanged', {
                detail: { 
                    theme: themeName, 
                    darkMode: isDarkMode,
                    useCustomColors: useCustomColors,
                    customColors: useCustomColors ? currentSettings.customColors : null
                }
            }));
            
            console.log("Theme applied:", themeName, "Dark mode:", isDarkMode, "Custom colors:", useCustomColors);
        }

        // Save settings to localStorage
        function saveSettings() {
            try {
                console.log("Saving settings:", currentSettings);
                
                // Save RSS feeds
                const rssFeeds = document.getElementById('rss-feeds').value
                    .split('\n')
                    .map(url => url.trim())
                    .filter(url => url !== '');
                currentSettings.rssFeeds = rssFeeds;
                
                // Save settings with all necessary theme information
                localStorage.setItem('homeSettings', JSON.stringify(currentSettings));
                
                // Save commands
                const commandsArray = Array.from(commands.entries());
                localStorage.setItem('homeCommands', JSON.stringify(commandsArray));
                
                // Show a brief success message in the button
                const button = saveButton;
                const originalText = button.textContent;
                button.textContent = 'Saved!';
                button.disabled = true;
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 1500);
                
                // Apply the settings immediately
                applyTheme(currentSettings.theme, currentSettings.darkMode, currentSettings.useCustomColors);
            } catch (e) {
                console.error('Error saving settings:', e);
                alert('There was an error saving your settings. Please try again.');
            }
        }

        // Open add shortcut modal
        function openAddShortcutModal() {
            editingKey = null;
            modalTitle.textContent = 'Add Shortcut';
            shortcutKeyInput.value = '';
            shortcutNameInput.value = '';
            shortcutUrlInput.value = '';
            shortcutModal.classList.add('active');
        }

        // Open edit shortcut modal
        function openEditShortcutModal(key) {
            if (!commands.has(key)) return;
            
            const command = commands.get(key);
            editingKey = key;
            
            modalTitle.textContent = 'Edit Shortcut';
            shortcutKeyInput.value = key;
            shortcutNameInput.value = command.name || '';
            shortcutUrlInput.value = command.url || '';
            
            shortcutModal.classList.add('active');
        }

        // Close modal
        function closeModal() {
            shortcutModal.classList.remove('active');
        }

        // Save shortcut
        function onShortcutSave(e) {
            e.preventDefault();
            
            const key = shortcutKeyInput.value.trim().toLowerCase();
            const name = shortcutNameInput.value.trim();
            const url = shortcutUrlInput.value.trim();
            
            // Validate inputs
            if (!key || !name || !url) {
                alert('All fields are required.');
                return;
            }
            
            // Ensure key is a single character
            if (key.length !== 1) {
                alert('Key must be a single character.');
                return;
            }
            
            // If we're changing the key, check if it's already in use
            if (key !== editingKey && commands.has(key)) {
                alert(`Key "${key}" is already in use. Please choose another.`);
                return;
            }
            
            // Create or update the command
            const command = { name, url };
            
            // If we're changing the key, remove the old entry
            if (editingKey && editingKey !== key) {
                commands.delete(editingKey);
            }
            
            // Set the new command
            commands.set(key, command);
            
            // Re-render shortcuts
            renderShortcuts();
            
            // Close the modal
            closeModal();
        }

        // Delete shortcut
        function deleteShortcut(key) {
            if (!commands.has(key)) return;
            
            const command = commands.get(key);
            if (confirm(`Delete the shortcut "${key}" - ${command.name}?`)) {
                commands.delete(key);
                renderShortcuts();
            }
        }

        // Export settings and commands
        function exportSettings() {
            try {
                // Create an object with all settings and commands
                const exportData = {
                    settings: currentSettings,
                    commands: Array.from(commands.entries())
                };
                
                // Convert to JSON string
                const exportString = JSON.stringify(exportData, null, 2);
                
                // Create a Blob with the data
                const blob = new Blob([exportString], { type: 'application/json' });
                
                // Create a download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'home_settings_' + new Date().toISOString().slice(0, 10) + '.json';
                
                // Trigger the download
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (e) {
                console.error('Error exporting settings:', e);
                alert('There was an error exporting your settings. Please try again.');
            }
        }
        
        // Open import modal
        function openImportModal() {
            importDataTextarea.value = '';
            importError.classList.remove('active');
            importFileName.textContent = '';
            importFileInput.value = ''; // Clear any previously selected file
            importModal.classList.add('active');
        }
        
        // Close import modal
        function closeImportModal() {
            importModal.classList.remove('active');
        }
        
        // Handle file selection
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) {
                importFileName.textContent = '';
                return;
            }
            
            // Display the selected filename
            importFileName.textContent = file.name;
            
            // Clear the textarea since we'll use the file
            importDataTextarea.value = '';
            
            // Clear any previous error
            importError.classList.remove('active');
        }
        
        // Import settings and commands
        function importSettings() {
            try {
                // Check if we have a file selected
                if (importFileInput.files.length > 0) {
                    const file = importFileInput.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        try {
                            const fileContents = event.target.result;
                            processImportData(fileContents);
                        } catch (e) {
                            console.error('Error processing imported file:', e);
                            importError.textContent = 'Invalid file format. Please provide a valid JSON file.';
                            importError.classList.add('active');
                        }
                    };
                    
                    reader.onerror = function() {
                        importError.textContent = 'Error reading file. Please try again.';
                        importError.classList.add('active');
                    };
                    
                    reader.readAsText(file);
                } else {
                    // No file selected, try to use textarea content
                    const importString = importDataTextarea.value.trim();
                    
                    if (!importString) {
                        importError.textContent = 'Please select a file or paste your settings data.';
                        importError.classList.add('active');
                        return;
                    }
                    
                    processImportData(importString);
                }
            } catch (e) {
                console.error('Error importing settings:', e);
                importError.textContent = 'An error occurred during import. Please try again.';
                importError.classList.add('active');
            }
        }
        
        // Process the imported data
        function processImportData(dataString) {
            try {
                // Parse the JSON data
                const importData = JSON.parse(dataString);
                
                // Validate the imported data format
                if (!importData.settings || !importData.commands) {
                    importError.textContent = 'Invalid data format. The file is missing required data.';
                    importError.classList.add('active');
                    return;
                }
                
                // Update current settings
                currentSettings = {
                    openLinksInNewTab: importData.settings.openLinksInNewTab || false,
                    darkMode: importData.settings.darkMode || false,
                    theme: importData.settings.theme || 'default',
                    cornerText: importData.settings.cornerText || '',
                    customColors: importData.settings.customColors || {
                        background: '#f8f5e6',
                        backgroundSecondary: '#f2edd0',
                        text: '#222222',
                        accent: '#333333'
                    },
                    useCustomColors: importData.settings.useCustomColors || false,
                    rssFeeds: importData.settings.rssFeeds || []
                };
                
                // Update UI to reflect imported settings
                darkModeSetting.checked = currentSettings.darkMode;
                themeSelect.value = currentSettings.theme;
                newTabSetting.checked = currentSettings.openLinksInNewTab;
                cornerTextSetting.value = currentSettings.cornerText;
                
                // Update RSS feeds textarea if rssFeeds exist
                if (currentSettings.rssFeeds && Array.isArray(currentSettings.rssFeeds)) {
                    document.getElementById('rss-feeds').value = currentSettings.rssFeeds.join('\n');
                }
                
                // Update commands
                commands = new Map(importData.commands);
                
                // Re-render shortcuts
                renderShortcuts();
                
                // Apply the imported theme
                applyTheme(currentSettings.theme, currentSettings.darkMode, currentSettings.useCustomColors);
                
                // Save the imported settings to localStorage
                saveSettings();
                
                // Close the import modal
                closeImportModal();
                
                // Show success message
                alert('Settings imported successfully!');
            } catch (e) {
                console.error('Error processing import data:', e);
                importError.textContent = 'Invalid data format. Please provide a valid JSON file.';
                importError.classList.add('active');
            }
        }

        // Get colors for a specific theme
        function getThemeColors(themeName, isDarkMode) {
            const theme = THEMES[themeName] || THEMES.default;
            const colors = isDarkMode ? theme.dark : theme.light;
            
            // Extract the background colors from gradient if available
            let background = colors.background;
            let backgroundSecondary = colors.background;
            
            if (colors.gradient && colors.gradient !== 'none') {
                // Try to extract colors from gradient
                const gradientMatch = colors.gradient.match(/linear-gradient\([^,]+,\s*([^,]+),\s*([^)]+)\)/);
                if (gradientMatch && gradientMatch.length >= 3) {
                    background = gradientMatch[1].trim();
                    backgroundSecondary = gradientMatch[2].trim();
                }
            }
            
            return {
                background: background,
                backgroundSecondary: backgroundSecondary,
                text: colors.text,
                accent: colors.accent
            };
        }
    </script>
</body>
</html>